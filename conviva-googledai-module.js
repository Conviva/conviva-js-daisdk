/*! (C) 2021 Conviva, Inc. All rights reserved. Confidential and proprietary. */

!function(o,n){var e;"function"==typeof define&&define.amd?define(n):("object"==typeof exports||"object"==typeof module&&module.exports)&&(module.exports=n()),void 0!==o&&o&&(void 0!==o.Conviva&&o.Conviva?o.Conviva.AdProxyMonitor||o.ConvivaModuleLoading||(e=n(),o.ConvivaModuleLoading=!0,o.Conviva.AdProxyMonitor=e.AdProxyMonitor,o.Conviva.Impl.GoogleDaiProxy=e.Impl.GoogleDaiProxy,delete o.ConvivaModuleLoading):o.ConvivaModule||o.ConvivaModuleLoading||(o.ConvivaModuleLoading=!0,o.ConvivaModule=n(),delete o.ConvivaModuleLoading))}(this,function(){var i={};return function(){"use strict";!function(){i.AdProxyMonitor={o:null,release:function(){this.o&&this.o.cleanup()},initConvivaDropIn:function(o,n,e,l,t){if(null!==o)return this.o=new i.Impl.GoogleDaiProxy(o,n,e,l,t),this.o;throw new Error("No Ad Manager proxy initialized")}};void 0!==i&&(i.Impl=i.Impl||{},i.Impl.GoogleDaiProxy=function(o,n,e,y,l){var t,v=this,i="CONVIVA",u=[google.ima.dai.api.StreamEvent.Type.AD_BREAK_STARTED,google.ima.dai.api.StreamEvent.Type.AD_BREAK_ENDED,google.ima.dai.api.StreamEvent.Type.SKIPPED,google.ima.dai.api.StreamEvent.Type.AD_PROGRESS,google.ima.dai.api.StreamEvent.Type.COMPLETE,google.ima.dai.api.StreamEvent.Type.FIRST_QUARTILE,google.ima.dai.api.StreamEvent.Type.LOADED,google.ima.dai.api.StreamEvent.Type.MIDPOINT,google.ima.dai.api.StreamEvent.Type.STARTED,google.ima.dai.api.StreamEvent.Type.THIRD_QUARTILE,google.ima.dai.api.StreamEvent.Type.ERROR,google.ima.dai.api.StreamEvent.Type.AD_PERIOD_STARTED,google.ima.dai.api.StreamEvent.Type.AD_PERIOD_ENDED],r=1,g={};function f(o){switch(o.type!==google.ima.dai.api.StreamEvent.Type.AD_PROGRESS&&k("onStreamManagerEvent event="+o.type),o.type){case google.ima.dai.api.StreamEvent.Type.AD_BREAK_ENDED:v.n||c(),v.n&&v.e&&(v.n.reportAdPlayerEvent(y.Constants.Events.USER_WAIT_ENDED),v.e=!1,v.l.getVideoAnalytics().setAdAnalytics(v.n));break;case google.ima.dai.api.StreamEvent.Type.AD_BREAK_STARTED:a(o),s();break;case google.ima.dai.api.StreamEvent.Type.LOADED:v.t=o.getStreamData().url,v.i=o.getStreamData().streamId;break;case google.ima.dai.api.StreamEvent.Type.STARTED:a(o),s(),d("start",o);break;case google.ima.dai.api.StreamEvent.Type.FIRST_QUARTILE:a(o),s(),d("firstQuartile",o);break;case google.ima.dai.api.StreamEvent.Type.MIDPOINT:a(o),s(),d("midpoint",o);break;case google.ima.dai.api.StreamEvent.Type.THIRD_QUARTILE:a(o),s(),d("thirdQuartile",o);break;case google.ima.dai.api.StreamEvent.Type.AD_PROGRESS:break;case google.ima.dai.api.StreamEvent.Type.SKIPPED:v.u&&v.l&&(v.l.reportAdSkipped(),v.l.getVideoAnalytics().setAdAnalytics(null),v.u=!1);break;case google.ima.dai.api.StreamEvent.Type.COMPLETE:d("complete",o),v.u&&v.l&&(v.l.reportAdEnded(),v.u=!1,v.l.getVideoAnalytics().setAdAnalytics(null));break;case google.ima.dai.api.StreamEvent.Type.ERROR:!function(o){var n=null;o.getStreamData()&&(n=o.getStreamData().errorMessage);{var e;v.l&&(n=n||"Ad Failed",v.u||(p(o.getAd(),!1,v.l),(e={})[y.Constants.ASSET_NAME]="Ad Failed",v.l.setAdInfo(e)),v.l.reportAdFailed(n),v.l.getVideoAnalytics().setAdAnalytics(null),v.u=!1)}v.n&&(n=n||"Slate Failed",p(o.getAd(),!0,v.n),v.n.reportAdFailed(n),v.n.getVideoAnalytics().setAdAnalytics(null),v.n.release(),v.n=null)}(o);break;case google.ima.dai.api.StreamEvent.Type.AD_PERIOD_STARTED:a(o),n=o,v.l&&v.l.getVideoAnalytics()&&(v.n||(v.n=y.Analytics.buildAdAnalytics(v.l.getVideoAnalytics()),v.l.getVideoAnalytics().setAdAnalytics(v.n),v.n.reportAdStarted(p(n.getAd(),!0,v.n)),v.n.reportAdMetric(y.Constants.Playback.PLAYER_STATE,y.Constants.PlayerState.PLAYING,i,r)));break;case google.ima.dai.api.StreamEvent.Type.AD_PERIOD_ENDED:c(),v.n&&(v.n.reportAdEnded(),v.n.getVideoAnalytics().setAdAnalytics(null),v.n.release(),v.n=null)}var n}function a(o){var n,e;!v.r&&v.l&&(e=n=null,"function"==typeof o.getAdPodInfo&&void 0!==o.getAdPodInfo()&&o.getAdPodInfo()&&(n=b(o.getAdPodInfo(),v.l.getAdPlayerMonitor().getContentMetadata()),"function"==typeof o.getAdPodInfo().getMaxDuration&&"number"==typeof o.getAdPodInfo().getMaxDuration()&&(e=o.getAd().getAdPodInfo().getMaxDuration())),o={},n&&(o[y.Constants.POD_POSITION]=n),e&&(o[y.Constants.POD_DURATION]=e),o[y.Constants.POD_INDEX]=v.g,v.l.getVideoAnalytics().reportAdBreakStarted(y.Constants.AdType.SERVER_SIDE,y.Constants.AdPlayer.CONTENT,o),v.r=!0)}function c(){v.r&&v.l&&(v.r=!1,v.l.getVideoAnalytics().reportAdBreakEnded(),v.g++)}function s(){v.r&&v.n&&!v.e&&(v.e=!0,v.n.reportAdPlayerEvent(y.Constants.Events.USER_WAIT_STARTED),v.l.getVideoAnalytics().setAdAnalytics(null))}function d(o,n){!v.u&&v.l&&(v.l.getVideoAnalytics().setAdAnalytics(v.l),v.l.reportAdStarted(p(n.getAd(),!1,v.l,o)),v.l.reportAdMetric(y.Constants.Playback.PLAYER_STATE,y.Constants.PlayerState.PLAYING,i,r),v.u=!0)}function b(o,n){var e="Mid-roll";return e=n[y.Constants.IS_LIVE]===y.Constants.StreamType.VOD&&"function"==typeof o.getPodIndex&&"number"==typeof o.getPodIndex()?0===(o=o.getPodIndex())?"Pre-roll":-1===o?"Post-roll":"Mid-roll":e}function p(o,n,e,l){var t,i,u,r,g,f,a,c,s,d,p;e&&(g=o,f=t={},a=n,(c=e)&&(s=c.getAdPlayerMonitor().getContentMetadata(),p=c.getPlayerMonitor().getContentMetadata(),a?((c=p.assetName)&&(f["c3.ad.videoAssetName"]=c),f[y.Constants.ASSET_NAME]="slate",f[y.Constants.IS_LIVE]=y.Constants.StreamType.LIVE):g&&(s&&s.assetName||(f[y.Constants.ASSET_NAME]=g.getTitle()),s&&0<=s.duration||(f[y.Constants.DURATION]=g.getDuration())),p&&(a||s&&s.streamType!==y.Constants.StreamType.UNKNOWN||(d=p.streamType)!==y.Constants.StreamType.UNKNOWN&&(f[y.Constants.IS_LIVE]=d),s&&s.defaultResource||(d=p.defaultResource)&&(f[y.Constants.DEFAULT_RESOURCE]=d),s&&-1<=s.encodedFrameRate||-1!==(p=p.encodedFrameRate)&&(f[y.Constants.ENCODED_FRAMERATE]=p)),s&&s.streamUrl||v.t&&(f[y.Constants.STREAM_URL]=v.t)),f=o,o=n,n=l,(l=t)["c3.ad.adStitcher"]="Google DAI",l["c3.ad.technology"]=y.Constants.AdType.SERVER_SIDE,l["c3.ad.adManagerName"]="Google IMA SDK",l["c3.ad.id"]="NA",l["c3.ad.system"]="NA",l["c3.ad.mediaFileApiFramework"]="NA",l["c3.ad.firstAdSystem"]="NA",l["c3.ad.firstAdId"]="NA",l["c3.ad.firstCreativeId"]="NA",l[y.Constants.IS_LIVE]===y.Constants.StreamType.LIVE&&(l["c3.ad.position"]="Mid-roll"),l["c3.ad.isSlate"]=""+o,n&&(l["c3.ad.sessionStartEvent"]=n),v.i&&(l["c3.ad.streamId"]=v.i),f&&("function"==typeof f.getAdId&&"string"==typeof f.getAdId()&&""!==f.getAdId()&&(l["c3.ad.id"]=f.getAdId()),"function"==typeof f.getAdSystem&&"string"==typeof f.getAdSystem()&&""!==f.getAdSystem()&&(l["c3.ad.system"]=f.getAdSystem()),"function"==typeof f.getApiFramework&&"string"==typeof f.getApiFramework()&&""!==f.getApiFramework()&&(l["c3.ad.mediaFileApiFramework"]=f.getApiFramework()),"function"==typeof f.getCreativeId&&"string"==typeof f.getCreativeId()&&""!==f.getCreativeId()&&(l["c3.ad.creativeId"]=f.getCreativeId()),"function"==typeof f.getAdvertiserName&&"string"==typeof f.getAdvertiserName()&&""!==f.getAdvertiserName()&&(l["c3.ad.advertiser"]=f.getAdvertiserName()),"function"==typeof f.getAdPodInfo&&void 0!==f.getAdPodInfo()&&f.getAdPodInfo()&&("function"==typeof f.getAdPodInfo().getAdPosition&&"number"==typeof f.getAdPodInfo().getAdPosition()&&(l["c3.ad.sequence"]=""+f.getAdPodInfo().getAdPosition()),l["c3.ad.position"]||(l["c3.ad.position"]=b(f.getAdPodInfo(),l))),r=f.getWrapperAdIds()&&0!==f.getWrapperAdIds().length?(r=f.getWrapperAdIds().length,i=f.getWrapperAdSystems()[r-1],u=f.getWrapperAdIds()[r-1],f.getWrapperCreativeIds()[r-1]):(i=f.getAdSystem(),u=f.getAdId(),f.getCreativeId()),l["c3.ad.firstAdSystem"]=""+i,l["c3.ad.firstAdId"]=""+u,l["c3.ad.firstCreativeId"]=""+r,void 0!==f.getUniversalAdIds()&&f.getUniversalAdIds()&&0<f.getUniversalAdIds().length&&("string"==typeof f.getUniversalAdIds()[0].getAdIdRegistry()&&"unknown"!==f.getUniversalAdIds()[0].getAdIdRegistry()&&""!==f.getUniversalAdIds()[0].getAdIdRegistry()&&(l["c3.ad.univAdIdReg"]=f.getUniversalAdIds()[0].getAdIdRegistry()),"string"==typeof f.getUniversalAdIds()[0].getAdIdValue()&&"unknown"!==f.getUniversalAdIds()[0].getAdIdValue()&&""!==f.getUniversalAdIds()[0].getAdIdValue()&&(l["c3.ad.univAdIdVal"]=f.getUniversalAdIds()[0].getAdIdValue()))),t[y.Constants.MODULE_NAME]="GD",t[y.Constants.MODULE_VERSION]="4.2.0",e.setAdInfo(t),(t={})[y.Constants.FRAMEWORK_NAME]="Google IMA SDK",e.setAdPlayerInfo(t))}function k(o){v.f&&v.f.log(o,y.SystemSettings.LogLevel.DEBUG)}g.ended=function(){k("onended event"),v.u&&v.l&&(v.l.reportAdEnded(),v.u=!1,v.l.getVideoAnalytics().setAdAnalytics(null))},g.error=function(){k("onerror event="+v.a.error.message),v.u&&v.l&&(v.l.reportAdFailed(v.a.error.message),v.l.getVideoAnalytics().setAdAnalytics(null),v.u=!1),v.n&&(v.n.reportAdFailed(v.a.error.message),v.n.getVideoAnalytics().setAdAnalytics(null),v.n.release(),v.n=null)},this.cleanup=function(){var o;!function(o){if(o)for(var n in g)o.removeEventListener(n,g[n].bind(this))}(v.a),(o=v.c)&&o.removeEventListener(u,f,!1),v.a=null,v.c=null,v.n=null,v.l=null,v.u=!1,v.s=null,v.d=null,v.a=null,v.r=!1,v.e=!1,v.p=-1,v.y=null,v.f=null,v.g=1,v.t=null,v.i=null},v.i=null,v.t=null,v.a=null,v.v=null,v.n=null,v.u=!1,v.b=!1,v.s={},v.d={},v.a=null,v.r=!1,v.p=-1,v.g=1,v.t=null,v.i=null,v.k=-1,v.A=-1,v.v=-1,v.y=l,v.c=o,v.l=e,v.f=v.y.buildLogger(),v.f.setModuleName("GoogleDAIProxy"),(t=v.c)&&t.addEventListener(u,f,!1),void 0!==n&&n&&(v.a=n[y.Constants.IMASDK_CONTENT_PLAYER],function(o){if(o)for(var n in g)o.addEventListener(n,g[n].bind(this))}(v.a))})}()}(),i});