/*! (C) 2021 Conviva, Inc. All rights reserved. Confidential and proprietary. */

!function(o,e){var n;"function"==typeof define&&define.amd?define(e):("object"==typeof exports||"object"==typeof module&&module.exports)&&(module.exports=e()),void 0!==o&&o&&(void 0!==o.Conviva&&o.Conviva?o.Conviva.AdProxyMonitor||o.ConvivaModuleLoading||(n=e(),o.ConvivaModuleLoading=!0,o.Conviva.AdProxyMonitor=n.AdProxyMonitor,o.Conviva.Impl.GoogleDaiProxy=n.Impl.GoogleDaiProxy,delete o.ConvivaModuleLoading):o.ConvivaModule||o.ConvivaModuleLoading||(o.ConvivaModuleLoading=!0,o.ConvivaModule=e(),delete o.ConvivaModuleLoading))}(this,function(){var i={};return function(){"use strict";!function(){i.AdProxyMonitor={o:null,release:function(){this.o&&this.o.cleanup()},initConvivaDropIn:function(o,e,n,t,l){if(null!==o)return this.o=new i.Impl.GoogleDaiProxy(o,e,n,t,l),this.o;throw new Error("No Ad Manager proxy initialized")}};void 0!==i&&(i.Impl=i.Impl||{},i.Impl.GoogleDaiProxy=function(o,e,n,v,t){var l,y=this,i="CONVIVA",r=[google.ima.dai.api.StreamEvent.Type.AD_BREAK_STARTED,google.ima.dai.api.StreamEvent.Type.AD_BREAK_ENDED,google.ima.dai.api.StreamEvent.Type.SKIPPED,google.ima.dai.api.StreamEvent.Type.AD_PROGRESS,google.ima.dai.api.StreamEvent.Type.COMPLETE,google.ima.dai.api.StreamEvent.Type.FIRST_QUARTILE,google.ima.dai.api.StreamEvent.Type.LOADED,google.ima.dai.api.StreamEvent.Type.MIDPOINT,google.ima.dai.api.StreamEvent.Type.STARTED,google.ima.dai.api.StreamEvent.Type.THIRD_QUARTILE,google.ima.dai.api.StreamEvent.Type.ERROR,google.ima.dai.api.StreamEvent.Type.AD_PERIOD_STARTED,google.ima.dai.api.StreamEvent.Type.AD_PERIOD_ENDED],u=1,f={};function g(){var o=y.e.buffered;if("number"!=typeof o)return-1;for(var e=0,n=0;n<o.length;n++){var t=o.start(n),l=o.end(n);t<=y.e.currentTime&&y.e.currentTime<l&&(e+=l-y.e.currentTime)}return 1e3*e}function a(o){switch(o.type!==google.ima.dai.api.StreamEvent.Type.AD_PROGRESS&&d("onStreamManagerEvent event="+o.type),o.type){case google.ima.dai.api.StreamEvent.Type.AD_BREAK_ENDED:y.n&&y.t&&(y.n=!1,y.t.reportAdBreakEnded(),y.l++,y.i&&y.i.reportAdPlayerEvent(v.Constants.Events.USER_WAIT_ENDED));break;case google.ima.dai.api.StreamEvent.Type.AD_BREAK_STARTED:c(o);break;case google.ima.dai.api.StreamEvent.Type.LOADED:y.r=o.getStreamData().url,y.u=o.getStreamData().streamId;break;case google.ima.dai.api.StreamEvent.Type.STARTED:c(o),s("start",o);break;case google.ima.dai.api.StreamEvent.Type.FIRST_QUARTILE:c(o),s("firstQuartile",o);break;case google.ima.dai.api.StreamEvent.Type.MIDPOINT:c(o),s("midpoint",o);break;case google.ima.dai.api.StreamEvent.Type.THIRD_QUARTILE:c(o),s("thirdQuartile",o);break;case google.ima.dai.api.StreamEvent.Type.AD_PROGRESS:y.f&&y.t&&y.e&&(y.t.reportAdMetric(v.Constants.Playback.PLAY_HEAD_TIME,parseInt(1e3*y.e.currentTime,10),i,u),y.g===y.e.videoWidth&&y.a===y.e.videoHeight||(y.g=y.e.videoWidth,y.a=y.e.videoHeight,y.t.reportAdMetric(v.Constants.Playback.RESOLUTION,y.e.videoWidth,y.e.videoHeight,i,u)),e=parseInt(g(),10),y.c!==e&&(y.c=e,y.t.reportAdMetric(v.Constants.Playback.BUFFER_LENGTH,e,i,u)));break;case google.ima.dai.api.StreamEvent.Type.SKIPPED:y.f&&y.t&&(y.t.reportAdSkipped(),y.f=!1);break;case google.ima.dai.api.StreamEvent.Type.COMPLETE:c(o),s("complete",o),y.f&&y.t&&(y.t.reportAdEnded(),y.f=!1);break;case google.ima.dai.api.StreamEvent.Type.ERROR:!function(o){var e=null;o.getStreamData()&&(e=o.getStreamData().errorMessage);{var n;y.t&&(e=e||"Ad Failed",y.f||(p(o.getAd(),!1,y.t),(n={})[v.Constants.ASSET_NAME]="Ad Failed",y.t.setAdInfo(n)),y.t.reportAdFailed(e),y.f=!1)}y.i&&(e=e||"Slate Failed",p(o.getAd(),!0,y.i),y.i.reportAdFailed(e),y.i.release(),y.i=null)}(o);break;case google.ima.dai.api.StreamEvent.Type.AD_PERIOD_STARTED:e=o,y.t&&y.t.getVideoAnalytics()&&(y.i||(y.i=v.Analytics.buildAdAnalytics(y.t.getVideoAnalytics()),y.i.setCallback(function(){!y.f&&y.i&&y.e&&(y.g===y.e.videoWidth&&y.a===y.e.videoHeight||(y.g=y.e.videoWidth,y.a=y.e.videoHeight,y.i.reportAdMetric(v.Constants.Playback.RESOLUTION,y.e.videoWidth,y.e.videoHeight,u)),y.i.reportAdMetric(v.Constants.Playback.PLAY_HEAD_TIME,parseInt(1e3*y.e.currentTime,10),i,u),y.i.reportAdMetric(v.Constants.Playback.BUFFER_LENGTH,parseInt(g(),10),i,u))}),y.i.reportAdStarted(p(e.getAd(),!0,y.i)),y.i.reportAdMetric(v.Constants.Playback.PLAYER_STATE,v.Constants.PlayerState.PLAYING,i,u)));break;case google.ima.dai.api.StreamEvent.Type.AD_PERIOD_ENDED:y.i&&(y.i.reportAdEnded(),y.i.release(),y.i=null)}var e}function c(o){var e,n;!y.n&&y.t&&(y.i&&y.i.reportAdPlayerEvent(v.Constants.Events.USER_WAIT_STARTED),n=e=null,"function"==typeof o.getAdPodInfo&&void 0!==o.getAdPodInfo()&&o.getAdPodInfo()&&(e=b(o.getAdPodInfo(),y.t.getAdPlayerMonitor().getContentMetadata()),"function"==typeof o.getAdPodInfo().getMaxDuration&&"number"==typeof o.getAdPodInfo().getMaxDuration()&&(n=o.getAd().getAdPodInfo().getMaxDuration())),o={},e&&(o[v.Constants.POD_POSITION]=e),n&&(o[v.Constants.POD_DURATION]=n),o[v.Constants.POD_INDEX]=y.l,y.t.reportAdBreakStarted(v.Constants.AdType.SERVER_SIDE,v.Constants.AdPlayer.CONTENT,o),y.n=!0)}function s(o,e){!y.f&&y.t&&(y.t.reportAdStarted(p(e.getAd(),!1,y.t,o)),y.t.reportAdMetric(v.Constants.Playback.PLAYER_STATE,v.Constants.PlayerState.PLAYING,i,u),y.e&&(y.g=y.e.videoWidth,y.a=y.e.videoHeight,y.c=parseInt(g(),10),y.t.reportAdMetric(v.Constants.Playback.RESOLUTION,y.e.videoWidth,y.e.videoHeight,u),y.t.reportAdMetric(v.Constants.Playback.PLAY_HEAD_TIME,parseInt(1e3*y.e.currentTime,10),i,u),y.t.reportAdMetric(v.Constants.Playback.BUFFER_LENGTH,y.c,i,u)),y.f=!0)}function b(o,e){var n="Mid-roll";return n=e[v.Constants.IS_LIVE]===v.Constants.StreamType.VOD&&"function"==typeof o.getPodIndex&&"number"==typeof o.getPodIndex()?0===(o=o.getPodIndex())?"Pre-roll":-1===o?"Post-roll":"Mid-roll":n}function p(o,e,n,t){var l,i,r,u,f,g,a,c,s,p,d;n&&(f=o,g=l={},a=e,(c=n)&&(s=c.getAdPlayerMonitor().getContentMetadata(),d=c.getPlayerMonitor().getContentMetadata(),a?((c=d.assetName)&&(g["c3.ad.videoAssetName"]=c),g[v.Constants.ASSET_NAME]="slate",g[v.Constants.IS_LIVE]=v.Constants.StreamType.LIVE):f&&(s&&s.assetName||(g[v.Constants.ASSET_NAME]=f.getTitle()),s&&0<=s.duration||(g[v.Constants.DURATION]=f.getDuration())),d&&(a||s&&s.streamType!==v.Constants.StreamType.UNKNOWN||(p=d.streamType)!==v.Constants.StreamType.UNKNOWN&&(g[v.Constants.IS_LIVE]=p),s&&s.defaultResource||(p=d.defaultResource)&&(g[v.Constants.DEFAULT_RESOURCE]=p),s&&-1<=s.encodedFrameRate||-1!==(d=d.encodedFrameRate)&&(g[v.Constants.ENCODED_FRAMERATE]=d)),s&&s.streamUrl||y.r&&(g[v.Constants.STREAM_URL]=y.r)),g=o,o=e,e=t,(t=l)["c3.ad.adStitcher"]="Google DAI",t["c3.ad.technology"]=v.Constants.AdType.SERVER_SIDE,t["c3.ad.adManagerName"]="Google IMA SDK",t["c3.ad.id"]="NA",t["c3.ad.system"]="NA",t["c3.ad.mediaFileApiFramework"]="NA",t["c3.ad.firstAdSystem"]="NA",t["c3.ad.firstAdId"]="NA",t["c3.ad.firstCreativeId"]="NA",t[v.Constants.IS_LIVE]===v.Constants.StreamType.LIVE&&(t["c3.ad.position"]="Mid-roll"),t["c3.ad.isSlate"]=""+o,e&&(t["c3.ad.sessionStartEvent"]=e),y.u&&(t["c3.ad.streamId"]=y.u),g&&("function"==typeof g.getAdId&&"string"==typeof g.getAdId()&&""!==g.getAdId()&&(t["c3.ad.id"]=g.getAdId()),"function"==typeof g.getAdSystem&&"string"==typeof g.getAdSystem()&&""!==g.getAdSystem()&&(t["c3.ad.system"]=g.getAdSystem()),"function"==typeof g.getApiFramework&&"string"==typeof g.getApiFramework()&&""!==g.getApiFramework()&&(t["c3.ad.mediaFileApiFramework"]=g.getApiFramework()),"function"==typeof g.getCreativeId&&"string"==typeof g.getCreativeId()&&""!==g.getCreativeId()&&(t["c3.ad.creativeId"]=g.getCreativeId()),"function"==typeof g.getAdvertiserName&&"string"==typeof g.getAdvertiserName()&&""!==g.getAdvertiserName()&&(t["c3.ad.advertiser"]=g.getAdvertiserName()),"function"==typeof g.getAdPodInfo&&void 0!==g.getAdPodInfo()&&g.getAdPodInfo()&&("function"==typeof g.getAdPodInfo().getAdPosition&&"number"==typeof g.getAdPodInfo().getAdPosition()&&(t["c3.ad.sequence"]=""+g.getAdPodInfo().getAdPosition()),t["c3.ad.position"]||(t["c3.ad.position"]=b(g.getAdPodInfo(),t))),u=g.getWrapperAdIds()&&0!==g.getWrapperAdIds().length?(u=g.getWrapperAdIds().length,i=g.getWrapperAdSystems()[u-1],r=g.getWrapperAdIds()[u-1],g.getWrapperCreativeIds()[u-1]):(i=g.getAdSystem(),r=g.getAdId(),g.getCreativeId()),t["c3.ad.firstAdSystem"]=""+i,t["c3.ad.firstAdId"]=""+r,t["c3.ad.firstCreativeId"]=""+u,void 0!==g.getUniversalAdIds()&&g.getUniversalAdIds()&&0<g.getUniversalAdIds().length&&("string"==typeof g.getUniversalAdIds()[0].getAdIdRegistry()&&"unknown"!==g.getUniversalAdIds()[0].getAdIdRegistry()&&""!==g.getUniversalAdIds()[0].getAdIdRegistry()&&(t["c3.ad.univAdIdReg"]=g.getUniversalAdIds()[0].getAdIdRegistry()),"string"==typeof g.getUniversalAdIds()[0].getAdIdValue()&&"unknown"!==g.getUniversalAdIds()[0].getAdIdValue()&&""!==g.getUniversalAdIds()[0].getAdIdValue()&&(t["c3.ad.univAdIdVal"]=g.getUniversalAdIds()[0].getAdIdValue()))),l[v.Constants.MODULE_NAME]="GD",l[v.Constants.MODULE_VERSION]="4.1.0",n.setAdInfo(l),(l={})[v.Constants.FRAMEWORK_NAME]="Google IMA SDK",n.setAdPlayerInfo(l))}function d(o){y.s&&y.s.log(o,v.SystemSettings.LogLevel.DEBUG)}f.playing=function(){d("onplaying event"),y.f&&y.t?y.t.reportAdMetric(v.Constants.Playback.PLAYER_STATE,v.Constants.PlayerState.PLAYING,i,u):!y.n&&y.i&&y.i.reportAdMetric(v.Constants.Playback.PLAYER_STATE,v.Constants.PlayerState.PLAYING,i,u)},f.pause=function(){d("onpause event"),y.f&&y.t?y.t.reportAdMetric(v.Constants.Playback.PLAYER_STATE,v.Constants.PlayerState.PAUSED,i,u):!y.n&&y.i&&y.i.reportAdMetric(v.Constants.Playback.PLAYER_STATE,v.Constants.PlayerState.PAUSED,i,u)},f.waiting=function(){d("onwaiting event"),y.f&&y.t?y.t.reportAdMetric(v.Constants.Playback.PLAYER_STATE,v.Constants.PlayerState.BUFFERING,i,u):!y.n&&y.i&&y.i.reportAdMetric(v.Constants.Playback.PLAYER_STATE,v.Constants.PlayerState.BUFFERING,i,u)},f.seeking=function(){d("seek started event"),y.f&&y.t?y.t.reportAdMetric(v.Constants.Playback.SEEK_STARTED,i,u):!y.n&&y.i&&y.i.reportAdMetric(v.Constants.Playback.SEEK_STARTED,i,u)},f.seeked=function(){d("seek ended event"),y.f&&y.t?y.t.reportAdMetric(v.Constants.Playback.SEEK_ENDED,i,u):!y.n&&y.i&&y.i.reportAdMetric(v.Constants.Playback.SEEK_ENDED,v.Constants.PlayerState.BUFFERING,i,u)},f.ended=function(){d("onended event"),y.f&&y.t&&(y.t.reportAdEnded(),y.f=!1)},f.error=function(){d("onerror event="+y.e.error.message),y.f&&y.t&&(y.t.reportAdFailed(y.e.error.message),y.f=!1),y.i&&(y.i.reportAdFailed(y.e.error.message),y.i.release(),y.i=null)},this.cleanup=function(){var o;!function(o){if(o)for(var e in f)o.removeEventListener(e,f[e].bind(this))}(y.e),(o=y.p)&&o.removeEventListener(r,a,!1),y.e=null,y.p=null,y.i=null,y.t=null,y.f=!1,y.d=null,y.v=null,y.e=null,y.n=!1,y.y=-1,y.b=null,y.s=null,y.l=1,y.r=null,y.u=null},y.u=null,y.r=null,y.e=null,y.c=null,y.i=null,y.f=!1,y.k=!1,y.d={},y.v={},y.e=null,y.n=!1,y.y=-1,y.l=1,y.r=null,y.u=null,y.g=-1,y.a=-1,y.c=-1,y.b=t,y.p=o,y.t=n,y.s=y.b.buildLogger(),y.s.setModuleName("GoogleDAIProxy"),(l=y.p)&&l.addEventListener(r,a,!1),void 0!==e&&e&&(y.e=e[v.Constants.IMASDK_CONTENT_PLAYER],function(o){if(o)for(var e in f)o.addEventListener(e,f[e].bind(this))}(y.e))})}()}(),i});